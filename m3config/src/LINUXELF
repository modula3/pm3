%-------------------------------------------------- compilation environment ---

readonly TARGET            = "LINUXELF"
readonly DEFAULT_BUILD_DIR = TARGET
readonly OS_TYPE           = "POSIX"
readonly WORD_SIZE         = "32BITS"
readonly GNU_PLATFORM      = "i486--linuxelf"

% naming convention of the host
readonly NAMING_CONVENTIONS = "0"
%                                        object files       libraries
%  0=Unix                          =>  .o   .io    .mo       libXX.a
%  1=Unix with a grumpy C compiler =>  .o   _i.o   _m.o      libXX.a
%  2=Windows/NT                    =>  .obj .io    .mo       XX.lib
%

% naming convention of the target
% it is not necessary to define it if it is equal to NAMING_CONVENTIONS
% TARGET_NAMING_CONVENTIONS = "0"

%------------------------------------------------------------- export paths ---
% During the installation, destination directories that do not exist
% will be created.  You need the necessary permissions to do so; otherwise,
% the installation will fail, but can be restarted after you have 
% fixed the permissions.

INSTALL_ROOT = "/usr/local/modula3-3.6/"
%-- handy for installations that keep all M3 stuff together

BIN_INSTALL   = INSTALL_ROOT & "bin/" & TARGET      % executables
LIB_INSTALL   = INSTALL_ROOT & "lib/m3/" & TARGET   % libraries
DOC_INSTALL   = INSTALL_ROOT & "lib/m3/doc"         % documents
PKG_INSTALL   = INSTALL_ROOT & "lib/m3/pkg"         % packages
EMACS_INSTALL = INSTALL_ROOT & "lib/elisp"          % emacs lisp code
MAN_INSTALL   = INSTALL_ROOT & "man"                % man pages
HTML_INSTALL  = INSTALL_ROOT & "lib/m3/www"         % public hypertext

% The manual pages normally go in subdirectories man{1,...8} of
% the MAN_INSTALL directory.  If you prefer to have them all in
% a single section, define MAN_SECTION to be that section's name.
% MAN_SECTION = "l"

% On some systems (e.g. AFS) you must install public files in a different
% place from where you use them.  If that is the case for your system,
% specify the "use" location here, otherwise leave them alone.
BIN_USE   = BIN_INSTALL
LIB_USE   = LIB_INSTALL
PKG_USE   = PKG_INSTALL

readonly INSTALL_IMPLS = "TRUE"
% "TRUE"
%    => save all source files during the install
%    => makes debugging easier and browsing more fruitful
% "" (i.e. FALSE)
%    => save only the exported interfaces and templates 
%    => makes the installed system slightly smaller.

readonly NEED_OBJECTS = "TRUE"
% "TRUE"
%    => accumulate a list of derived objects in COMPILE_OBJECTS
%    => for building shared libraries in the library_hooks function below
% ""
%    => don't bother

%---------------------------------------------------------------------- X11 ---
% If you have X11R4 installed and would like the X11R4 binding interfaces
% to be built, define the procedure "import_X11R4" to import the libraries
% that are needed.  Otherwise, define "import_X11R4" to be an empty procedure.
%
% If you use the MIT server with DECnet support, you need X11 and dnet,
% otherwise X11 should be enough.
% 
% Since X11R5 is an extension of X11R4, you can use the X11R5 libraries
% instead of X11R4.  However, the Modula-3 binding interfaces have not
% yet been upgraded to X11R5.
%
% "import_X11R4" is called from the X11R4 package.
% "import_Motif" is called from the motif package.
% "import_DECPEX" is called from the PEX package.
% "import_OpenGL" is called from the opengl package.
% "import_TCP" is called from the tcp package.

readonly proc import_X11R4() is
  import_lib("Xaw",  "/usr/X11/lib")
  import_lib("Xmu",  "/usr/X11/lib")
  import_lib("Xext", "/usr/X11/lib")
  import_lib("Xt",   "/usr/X11/lib")
  import_lib("SM",   "/usr/X11/lib")
  import_lib("ICE",  "/usr/X11/lib")
  import_lib("X11",  "/usr/X11/lib")
end

readonly proc import_Motif() is
  import_lib("Xm",   "/usr/X11/lib")
end

readonly proc import_DECPEX() is
  % DEC PEX differs from MIT PEX, and is only supported on Digital machines.  
end

readonly proc import_OpenGL() is
  % import_lib (GLU,  "/usr/lib")
  % import_lib (GL,   "/usr/lib")
  % import_lib (Xext, "/usr/lib")
end

readonly proc import_TCP() is
end

readonly PLATFORM_SUPPORTS_X      = "TRUE"
readonly PLATFORM_SUPPORTS_MOTIF  = "TRUE"
readonly PLATFORM_SUPPORTS_DECPEX = ""
readonly PLATFORM_SUPPORTS_OPENGL = ""

% Does your X11 server have the shared memory extension?
readonly X11_WITH_SHARED_MEM = "TRUE"

%-------------------------------------------------------------------- emacs ---
% If you have emacs and want to compile ".el" files to ".elc" files,
% fill in the function below.  Otherwise, comment out or delete the
% entire function.  Note, the distributed code assumes gnuemacs version 19
% or later.

readonly proc emacs_compile (el) is
  local ret = 0
  ret = exec (["emacs", "-batch", "-f", "batch-byte-compile", el])
  if not equal(ret, 0) error("emacs failed with error code: ", ret) end
end

VERBOSE = ""
% ""    ==> don't echo the commands executed by the hooks
% TRUE  ==> echo the commands executed by the hooks

%--------------------------------------------------------------- C compiler ---

% C compiler with flags for compiling a single ".c" file.
% You can override this definition in your m3makefile by defining CC there.
CC = lookup ("CC", [ "gcc" ])

% "m3_compile_c" is called to compile C source files.  Note that this function
% is only called if your program or library explicitly includes C source
% code.
%   source: the name of the source file
%   object: the name of the object file to produces
%   includes: a list (array) of the name of the include files (no flags, only
%             the names)
%   optimize: if true, optimization is required, otherwise not.
%   debug:  if true, debug information is required, otherwise not.
%   shared: if true, the generated executable must be usable in a shared lib.
proc m3_compile_c (source, object, includes, optimize, debug, shared) is
  local cmd = [ CC, "-c", source]
  foreach i in includes
    cmd += "-I" & i
  end
  if object    cmd += [ "-o", object ] end
  if optimize  cmd += "-O2" end
  if debug     cmd += "-g"  end
  if shared    cmd += "-fPIC" end
  if VERBOSE write(cmd, CR) end
  return exec (cmd)
end

%------------------------------------------------------------------- linker ---

% C compiler with flags for linking
% You can override this definition in your m3makefile by defining LINK there.
LINK = lookup ("LINK", "ld")

% "m3_link" is called to produce a final executable.
%   prog: the name of the executable.
%   objects: a list (array) of objects to link into the executable.
%   imported_libs: a list (array) of 2-element array: the first element 
%     is the path of the library to import and the second is the name of 
%     the library.  The first element may be empty.
%   debug: if true, the executable must contain debugging information.
%   shared: if true, the final executable must use shared libs
proc m3_link (prog, objects, imported_libs, debug, shared) is
  local cmd = [ LINK ]
  if not shared cmd += [ "-static" ] end
  cmd += [ "-dynamic-linker", "/lib/ld-linux.so.1", 
    "/usr/lib/crt1.o",  "/usr/lib/crti.o", "/usr/lib/crtbegin.o"]
  cmd += [ "-o", prog, objects ]
  foreach i in imported_libs
    if not empty(i[0]) cmd += "-L" & i[0] end
    cmd += "-l" & i[1]
  end
  cmd += "-lm"
  cmd += [ "-L/usr/lib/gcc-lib/i486-linux/2.7.2.1",
                      "-L/usr/i486-linux/lib",
                      "-lgcc", "-lc", "-lgcc", "/usr/lib/crtend.o", 
                      "/usr/lib/crtn.o" ]

  if debug cmd += "-g" end

  if VERBOSE write(cmd, CR) end
  return exec (cmd)
end

%--------------------------------------------------------- library creation ---

% program to build library archives
% You can override this definition in your m3makefile by defining MAKELIB 
% there.
MAKELIB = lookup ("MAKELIB", [ "ar", "crus" ])

% program to build shared libraries
% You can override this definition in your m3makefile by defining MAKESHLIB
% there.
MAKESHLIB = lookup ("MAKESHLIB", "ld")

% program to index libraries
% You can override this definition in your m3makefile by defining RANLIB
% there.
RANLIB = lookup ("RANLIB", [ "touch" ])

% "m3_make_lib" is called to combine a collection of object modules into
% a library.
%   lib: the name of the library
%   objects: a list (array) of the object files to include in the library
%   imported_libs: a list (array) of the imported libraries
%   static: if true, build a static library
%   shared: if true, build a shared library
proc m3_make_lib (lib, objects, imported_libs, static, shared) is
  local ret = 0

  if static
    local lib_a    = format ("lib%s.a", lib)
    local cmd = [ MAKELIB, lib_a, objects, imported_libs ]
    if VERBOSE write(cmd, CR) end
    ret = exec (cmd)
    if not equal(ret, 0) return ret end
    cmd = [ RANLIB, lib_a ]
    if VERBOSE write(cmd, CR) end
    ret = exec (cmd)
  end

  if shared
    local lib_so   = format ("lib%s.so", lib)
    local lib_sox  = format ("lib%s.so.3", lib)
    local lib_soxx = format ("lib%s.so.3.5", lib)
    local args = [ "-shared", "-soname", lib_so, "-o", lib_soxx, 
	"/usr/lib/crti.o", "/usr/lib/crtbeginS.o", 
	objects, "/usr/lib/crtendS.o", "/usr/lib/crtn.o" ]


    if defined ("_all")
      local cmd = [ MAKESHLIB ]
      cmd += args
      if VERBOSE write(cmd, CR) end
      ret = exec (cmd)
      if not equal(ret, 0) return ret end
      %exec ("gcc -shared -Wl,-soname", "-Wl," & lib_so,
      %        "-o", lib_soxx, objects)
      link_file(lib_soxx, lib_sox)
      link_file(lib_soxx, lib_so)
      install_derived (lib_soxx)
      install_derived (lib_sox)
      install_derived (lib_so)
      install_link_to_derived (lib_sox, LIB_INSTALL)
      install_link_to_derived (lib_so, LIB_INSTALL)
    end
    deriveds (lib_soxx, [""])
    deriveds (lib_sox, [""])
    deriveds (lib_so, [""])
  end
  return ret
end

%---------------------------------------------------------------- assembler ---

% assembler
% You can override this definition in your m3makefile by defining ASM
% there.
ASM = lookup ("ASM", [ "as" ])

% "m3_assemble" is called to assemble files.  Note that this function
% is only called if your program or library explicitly includes assembly source
% code.
%  source: the name of the source file
%  object: the name of the object file to produce
%  optimize: if true, optimization is required, otherwise not.
%  debug: if true, the object file must contain debugging information.
%  shared: if true, the object file must be suitable for being incorporated
%    into a shared library. 
proc m3_assemble (source, object, optimize, debug, shared) is
  local cmd = [ ASM, "-o", object, source ]

  if VERBOSE write(cmd, CR) end
  return exec (cmd)
end

%--------------------------------------------------------- Modula-3 backend ---

% the Modula-3 IL to assembly language pass
% You can override this definition in your m3makefile by defining BACKEND
% there.
BACKEND = lookup ("BACKEND", [  LIB_USE & "/m3cgc1", "-fno-strength-reduce", "-quiet" ])

% For platforms without an integrated backend, "m3_backend" is called to
% translate Modula-3 intermediate code to object code.
%  source: the name of the source file to compile
%  object: the name of the object file to create
%  optimize: if true, do optimization
%  debug: if true, generate debug information
%  shared: if true, generate an object that can be used to make a shlib
proc m3_backend (source, object, optimize, debug, shared) is
  local cmd = [ BACKEND, "-o", object, source ]
  
  if optimize cmd += "-O" end
  if debug cmd += "-g" end
  if shared cmd += "-fPIC" end

  if VERBOSE write(cmd, CR) end
  return exec(cmd)
end

M3_BACKEND_EXTERNAL = ""
% "TRUE" => call m3_backend
% ""     => use an internal backend (default)

if M3_BACKEND_EXTERNAL
  M3_BACKEND_OUTPUT = "ASM"
else
  M3_BACKEND_OUTPUT = "OBJ"
end
% "ASM" => the backend produces assembly code (default)
% "OBJ" => it produces object code

%-------------------------------------------------------- Modula-3 compiler ---

% Default options
m3_option("-w1")
m3_option("-why")
m3_option("-g")

m3front_option("-unfold_nested_procs")

M3_COVERAGE_LIB = LIB_USE & "/report_coverage.o"
% --- library linked in programs compiled with "-Z" coverage option

% M3_STANDALONE = TRUE
% --- build a standalone executable using static libraries, otherwise use
% --- shared libraries

M3_GENERATE_LIB = "BOTH"
% "BOTH"   => generate both static and shared libraries
% "STATIC" => generate only a static library
% "SHARED" => generate only a shared library

% M3_HAS_LOADER = TRUE
% --- generate a loader info file with objects, libraries and timestamps

M3_M3MAIN = "BACKEND"
% "COMPILER" => generates _m3main.o using a C compiler
% "BACKEND"  => generates _m3main.o using the internal backend

proc build_standalone() is
   % --- reset the linker to avoid shared libraries.
   M3_STANDALONE = "TRUE"
end

proc build_shared() is
   % --- reset the linker to use shared libraries.
   M3_STANDALONE = ""
end

%------------------------------------------------------------- installation ---
% "install_file" is called during an "m3build install" for
% each file that neededs to be externally exported.

readonly proc install_file (src, dest, mode) is
  Note_install (src, dest)
  local ret = exec ([ "cp", "-p", "-d", "-f", src, dest ])
  % exec (["install", "-c", "-m", mode, src, dest])
end




