<HTML>
<HEAD>
<TITLE>A tour of the runtime</TITLE>
</HEAD>
<BODY>

<H1>A tour of the runtime</H1>
<P>

This section contains a brief introduction to the internal structure
of the runtime system.  This introduction is neither
comprehensive nor tutorial; it is merely intended as a stepping stone
for the courageous.
<P>

The runtime itself implements the
<A HREF="gc.html">garbage collector</A>,
Modula-3 startup code and a few miscellaneous functions.  The runtime
exists in the <TT>libm3/src/runtime</TT> directory.
<P>

The allocator and
<A HREF="gc.html">garbage collector</A>
are based on Joel Bartlett's
``<A HREF="../../../../intro/src/bib.html#m3-Bar88">mostly copying collector</A>''.
Since that paper, we've made a few
modifications to support a growing heap and to use extra information
that the Modula-3 compiler generates.
<P>

On some platforms
(e.g. <TT>DS3100</TT> and <TT>ALPHA_OSF</TT>) exceptions are
implemented by PC tables and a stack walker.
On all other platforms, exceptions are implemented with <TT>setjmp</TT>
and <TT>longjmp</TT>.  The
jump buffers and scope descriptors are chained together to form a
stack.
The <TT>ThreadF</TT>
interface holds the head of the chain.
There is a distinct chain for each thread.  When an exception is
raised, the chain is searched.  If a handler for the exception is
found, the exception is allowed to unwind the stack, otherwise a
runtime error is signaled.  To unwind the stack, a <TT>longjmp</TT> is
done to the first handler on the stack.  It does whatever cleanup is
necessary and passes control on up the stack to the next handler until
the exception is actually handled.
<P>

Reference types are represented at runtime by a ``typecell''.  Due to
separate compilation, opaque types and revelations, it is not possible
to fully initialize typecells at compile time.  Typecell
initialization is finished at link time.  A typecell contains a type's
typecode, a pointer to its parent typecell, the size of the types
referent and method list if any, the type's brand, the number of open
array dimensions, the type's fingerprint, and procedures to initialize
the typecell, initialize new instances of the type, print instances of
the type and trace the type for garbage collection.
<P>

At the beginning of the execution of the program, all global variables
are initialized, and the main bodies of the modules are invoked.  The
table that lists the module to be initialized is
generated by the linker part of the driver.
<P>

Other parts of the runtime, such as threads, are actually implemented
in the base library.
<P>

On Unix, <A HREF="scheduler.html">Thread switching</A>
is implemented with <TT>setjmp</TT> and <TT>longjmp</TT>.
A timer interrupt (<A HREF="signals.html">signal</A>)
is used to cause preemptive thread
switching.  The global variable
<TT>ThreadPosix.self</TT>
points to the
currently running thread.  The integer
<TT>RT0u.inCritical</TT>
is used by the runtime to prevent thread switching during garbage
collection and other ``atomic'' runtime operations.
<P>

On Windows/NT, Modula-3 threads are implemented as Win32 kernel threads.

<PRE>
Last modified on Thu Jan  4 11:07:58 PST 1996 by heydon
     modified on Thu Jun  1 08:16:58 PDT 1995 by kalsow
     modified on Tue Feb 18 13:23:15 PST 1992 by muller
</PRE>

<!--Copyright (C) 1992, 1996, Digital Equipment Corporation. All rights reserved.-->
</BODY>
</HTML>
