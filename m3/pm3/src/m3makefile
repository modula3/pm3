% Copyright (C) 1994, Digital Equipment Corporation
% All rights reserved.
% See the file COPYRIGHT for a full description.
%
% Last modified on Fri Aug 23 00:14:14 PDT 1996 by najork
%      modified on Mon Jun 19 08:07:53 PDT 1995 by kalsow
%

%
% When BOOTSTRAP is true, m3build and m3ship are taken from the "boot"
% directory. If EXPORTPATH or EXPORTRPATH are set, the binaries are
% shipped in the absolute or relative path specified.
%

local currentPhase = 1
local firstPhase = ""
local ret = 0

> "config.tmpl" in
  write("option(\"optimization\",\"T\")", CR)
end

BOOTSTRAP = lookup("BOOTSTRAP","")

if BOOTSTRAP
  m3build = [path() & SL & ".." & SL & "boot-" & TARGET & SL &"m3build" & SL &
      TARGET & SL & "m3build","-T",path() & SL & ".." & SL & "m3config" & SL &
      "src"]
  m3ship = [path() & SL & ".." & SL & "boot-" & TARGET & SL & "m3ship" & SL &
      TARGET & SL & "m3ship","-T",path() & SL & ".." & SL & "m3config" & SL &
      "src"]
else
  m3build = [BIN_USE & SL & "m3build"]
  m3ship = [BIN_USE & SL & "m3ship"]
end

m3build += "-F"
m3build += path() & SL & ".." & SL & TARGET & SL & "config.tmpl"

EXPORTPATH = lookup("EXPORTPATH","")
EXPORTRPATH = lookup("EXPORTRPATH","")

if EXPORTPATH
  if equal(OS_TYPE,"WIN32") EXPORTPATH = p2w(EXPORTPATH) end
end

if EXPORTRPATH
  if equal(OS_TYPE,"WIN32") EXPORTRPATH = p2w(EXPORTRPATH) end
  EXPORTPATH = path() & SL & ".." & SL & EXPORTRPATH
end

if EXPORTPATH
  >> "config.tmpl" in
    write("TARGET_BIN_INSTALL = BIN_INSTALL", CR)
    write("TARGET_LIB_INSTALL = LIB_INSTALL", CR)
    write("TARGET_DOC_INSTALL = DOC_INSTALL", CR)
    write("TARGET_PKG_INSTALL = PKG_INSTALL", CR)
    write("TARGET_EMACS_INSTALL = EMACS_INSTALL", CR)
    write("TARGET_MAN_INSTALL = MAN_INSTALL", CR)
    write("TARGET_HTML_INSTALL = HTML_INSTALL", CR)
    write("TARGET_BIN_USE = BIN_USE", CR)
    write("TARGET_LIB_USE = LIB_USE", CR)
    write("TARGET_PKG_USE = PKG_USE", CR)

    write("INSTALL_ROOT = \"" & escape(EXPORTPATH) & "\" & INSTALL_ROOT",CR)
    write("setInstallRoot(\"\",\"\")",CR)
  end
end

readonly proc BuildChunk (dir,pkg) is
  local ret = 0
  local cmd = [m3build]

  if equal(OS_TYPE,"WIN32") dir = p2w(dir) end

  local wd = ".." & SL & dir & SL & pkg

  if not stale (pkg, pkg)
    % we've already built this chunk
    write ("-- ", pkg, " done --", CR)
    %ret = exec ([ "rm", "-rf", BUILD_DIR] , [], wd)
    return
  end

  % let'm know what we're doing
  write (CR, "---------- building ", pkg," in ",dir," ----------", CR,CR)

  %
  % In the first phase, the documentation processing tools are not built
  % yet. Thus their use is skipped but the compiled files are kept for
  % the second pass shortly thereafter.
  %

  if firstPhase cmd += "-DUSE_M3DOC=" end

  % build and ship the chunk
  write(cmd, CR)
  ret = exec (cmd, [], wd)
  if not equal(ret, 0) error ("m3build failed with error code: ", ret) end
  write(m3ship, CR)
  ret = exec (m3ship, [], wd)
  if not equal(ret, 0) error ("m3ship failed with error code: ", ret) end

  if not firstPhase
    % If you don't want to delete derived objects as soon as they are
    % installed, comment out the following line.
    ret = exec ([ "rm", "-rf", BUILD_DIR] , [], wd)

    % remember that we've built this chunk
    ret = exec (["touch", pkg])
    if not equal(ret, 0) error ("touch failed with error code: ", ret) end
  end
end

local capabilities = {}

capabilities{OS_TYPE} = ""
if not defined("SKIP_LLSCAN") capabilities{"LLSCAN"} = "" end
if PLATFORM_SUPPORTS_MOTIF capabilities{"MOTIF"} = "" end
if PLATFORM_SUPPORTS_DECPEX capabilities{"DECPEX"} = "" end
if PLATFORM_SUPPORTS_OPENGL capabilities{"OPENGL"} = "" end
if PLATFORM_SUPPORTS_X capabilities{"X11"} = "" end

proc PkgInfo(name,subdirectory,subtree,bundle,type,bundleHead,buildPhase,
    dependency,buildPlatforms,buildReq,description) is
  local ok = ""

  foreach p in buildPlatforms
    if equal(p,"ALL") or equal(p,TARGET) ok = "T" end
  end

  foreach r in buildReq
    if not capabilities contains r ok = "" end
  end

  if ok and equal(buildPhase,currentPhase)
    BuildChunk(subdirectory,name)
  end
end

% Build the first few packages which have no requirements

currentPhase = 1
firstPhase = ""
include("PACKAGES")

% Build the core packages without documentation
currentPhase = 2
firstPhase = "T"
include("PACKAGES")

% Now that the documentation tools are ready, rebuild the core packages
firstPhase = ""
include("PACKAGES")

% Build the remaining packages
currentPhase = 3
include("PACKAGES")

% Use the package list to create the CVSsup configuration files

if defined("BUILD_CVSUP_FILES")
  ret = exec(["mkdir","sup"])

  proc PkgInfo(name,subdirectory,subtree,bundle,type,bundleHead,buildPhase,
      dependency,buildPlatforms,buildReq,description) is
    local ret = exec(["mkdir","sup/" & name])
    local fname = name

    if equal(subdirectory,".") subdirectory = ""
    else subdirectory = subdirectory & "/"
    end

    if equal(subtree,"src")
      subdirectory = subdirectory & name
      fname = "src"
    end

    > "sup/" & name & "/files" in
      write("upgrade " & fname,CR,"omitany *~",CR,"omitany *.bak",CR,
          "omitany *.tar",CR,"omitany *.Z",CR,"omitany *.gz",CR,
          "omitany *.tgz",CR,"omitany *.zip",CR)
    end

    > "sub/" & name & "/releases" in
      write("cvs	list=files prefix=/home/cvsroot/m3/pm3/" & 
          subdirectory," keywordprefix=/home/cvsroot/m3/pm3/" & 
          subdirectory & " norsync",CR)
    end
  end

  include("PACKAGES")
end

OtherPackage("pm3")
